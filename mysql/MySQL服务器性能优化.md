# 服务器性能剖析

## 性能优化简介

**性能度量指标：** 查询的响应时间

**优化目标：**一定的工作负载下尽可能减少响应时间



# Schema 与数据类型优化

## 正确选择数据类型

### #1. 数字类型

数据库分为两种类型的数字

* 整数

  **整数 ：指整型变量**

  **整型**其可以分为如下几种类型

  | 类型      | 存储空间(bit) |
  | --------- | ------------- |
  | TINYINT   | 8             |
  | SMALLINT  | 16            |
  | MEDIUMINT | 24            |
  | INT       | 32            |
  | BIGINT    | 64            |

  其中整型可以选择带符号与否，如果为UNSIGNED则其正数大小为SIGNED的一倍。

  MySQL可以为整数类型指定宽度，例如INT(11)，对于大多数应用是没有意义的，**它仅规定了MySQL客户端的显示字符的个数，而对于存储与计算 INT(11) 和 INT(1) 则是完全相同**

* 实数

  **实数 ： 指带小数部分的变量**

  | 类型    | 说明                                                         |
  | ------- | ------------------------------------------------------------ |
  | decimal | 用于存储精确的小数，其底层并不是基于浮点实现，而是字符串，所以不存在浮点误差的问题，但是面对大规模的计算，可能销量较低，此时可以用 BIGINT 乘相应倍数代替。 |
  | float   | 4字节，浮点计算可能存在误差                                  |
  | double  | 8字节，浮点计算可能存在误差                                  |

### #2. 字符串类型

varchar 和 char 是两种最主要的字符串类型，但是两者的区别和具体的存储引擎有关，假设在 InnoDB / MyISAM 中

* **VARCHAR 一般用于存储可变的长字符串**

  VARCHAR 会根据字符串的长度，可变的选择存储空间的长度，一般而言，VARCHAR需要额外的1～2个字节来标示字符串的长度

  也就是说，加入定义 **VARCHAR**(10) 但是实际的存储空间会根据真实的存入字符串分配，如果只存入一个字符，那么占用的字符串仅为2～3个。

  一般可以在如下两种情况下使用 VARCHAR

  1. 字符串的最大长度较平均长度大的多
  2. 使用了 UTF-8 这样的复杂数据集

* **CHAR 是定长存储的** 

  在设定好CHAR大小的时候，存储空间变为确定的

  即使用 **CHAR**(10) 存储时，不管存入的字符串大小，存储空间均为10个字节

  同时，CHAR类型还会将存入字符串末尾的空格默认去除，即存入为 `"abc "` 取出则为 `"abc"`

  一般而言，CHAR 可以用于以下情况的存储

  1. 定长的字符串，例如 MD_5 后的密码
  2. 状态位如 CHAR(1) 表示 是，否。因为CHAR不用浪费空间记录存入字符串的长度



### #3. 日期和时间类型

timestamp 和 datetime 可以存储相同的数据：时间和日期，精确到秒，但是 **timesape 只使用 datetime 一半**

**的存储空间，并且其可以根据时区的变化自动更新**

* datetime 能保存大范围的值，从 1001年~9999年

  可将日期封装到 YYYYMMDDHHMMSS 的整数中如

  `"2018-01-16 22:37:08"`

* timestamp 保存了从 1970年1月1日午夜以来的秒数，和UNIX时间戳相同，且只能从 1970年保存到 2038 年

  `FROM_UNIXTOME()` 函数可以将 UNIX 时间戳转化为日期

  `UNIX_TIMESTAMP()`函数则可以将日期转化为时间戳



### #4. 设计tips

1. **尽量避免使用NULL，因此NULL值会使得索引，值比较更加复杂**

   通常情况下需要指定NOT NULL，

2. 应该使用内建的类型如 date 而不是字符串来存储日期和时间

3. 应该使用整型而不是字符串来存储 IP 地址



## 特殊表

### #1. 计数器表



# 创建高性能索引





























